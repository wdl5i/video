/*!
 *  XmWebRtc 
 *  version: 1.0 
 *  COPYRIGHT © 2018 杭州雄迈信息技术有限公司
 */
!function(e){function t(o){if(n[o])return n[o].exports;var r=n[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var n={};t.m=e,t.c=n,t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:o})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=3)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(){}return e.clientID=function(){for(var e="",t=0;t<4;t++)e+=Math.ceil(1e5*Math.random());return e},e.log=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.logstatus&&console.log(e)},e.ajax=function(e,t,n,o){void 0===o&&(o=null),$.ajax({type:"POST",timeout:3e3,url:t,dataType:"json",contentType:"application/json; charset=utf-8",async:!1,data:JSON.stringify(e),success:n,error:o})},e.logstatus=!0,e}();t.Common=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(){}return e.coturn=function(e,t){return{RTCAccessProtocol:{Header:{MessageType:"MSG_COTURN_REQ"},Body:{SrcUuid:e,DstUuid:t,AuthCode:"xxxxxxxxxxxxxxxx"}}}},e.sdpOffer=function(e,t,n){return{RTCAccessProtocol:{Header:{MessageType:"MSG_CONNECT_REQ"},Body:{DstUuid:t,SrcUuid:e,AuthCode:"xxxxxxxxxxxxxxxx",channel:"0",streamType:"0",sdp:n,type:"offer"}}}},e.iceCandidate=function(e,t,n){return{RTCAccessProtocol:{Header:{MessageType:"MSG_CONNECT_REQ"},Body:{DstUuid:t,SrcUuid:e,candidate:n.candidate}}}},e.sdpAnswer=function(e,t){return{RTCAccessProtocol:{Header:{MessageType:"MSG_SDP_REQ"},Body:{DstUuid:t,SrcUuid:e}}}},e.iceCandidateAnswer=function(e,t){return{RTCAccessProtocol:{Header:{MessageType:"MSG_NEW_CONNECT_REQ"},Body:{DstUuid:t,SrcUuid:e}}}},e}();t.ParamConfig=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(0),r=n(8),a=function(){function e(e,t,n){this.sn=e,this.serverIp=t,this.serverPort=n,this.clientID="web_"+o.Common.clientID()}return e.prototype.createRTCPeerConnection=function(){var e={optional:[{DtlsSrtpKeyAgreement:!0}]},t=new RTCPeerConnection(null,e);return o.Common.log("createRTCPeerConnection created:",null!=t),t},e.prototype.sendOffer=function(e){var t={offerToReceiveAudio:1,offerToReceiveVideo:1},n=this;e.createOffer(function(t){e.setLocalDescription(new RTCSessionDescription(t)),n.createOfferSuccessCallback(e)},function(t){n.sendOfferFailureCallback(e,t)},t)},e.prototype.iceCandidate=function(e){var t=this;e.onicecandidate=function(n){n.candidate&&t.iceCandidateSuccessCallback(e,n)}},e.prototype.addStream=function(e){e.onaddstream=function(e){o.Common.log("addstream "),10==parseInt(e.stream.id.substring(12))&&($("#video")[0].srcObject=e.stream)}},e.prototype.createDataChannel=function(e){var t=this;t.sendChannel=e.createDataChannel("sendDataChannel"),o.Common.log("create datachannel000000000"),t.sendChannel.binaryType="arraybuffer",t.sendChannel.onopen=function(){return t.onSendChannelOpen.apply(t)},t.sendChannel.onclose=function(){return t.onSendChannelClose.apply(t)},t.sendChannel.onmessage=function(e){return t.onReceiveMessageCallback.apply(t,[e])},t.peerConnection.ondatachannel=function(e){o.Common.log("ondatachannel"),t.receiveChannel=e.channel,t.receiveChannel.binaryType="arraybuffer",t.receiveChannel.onopen=function(){return t.onReceiveChannelStateChange.apply(t)},t.receiveChannel.onclose=function(){return t.onReceiveChannelStateChange.apply(t)},t.receiveChannel.onmessage=function(e){return t.onReceiveMessageCallback.apply(t,[e])}}},e.prototype.onSendChannelOpen=function(){var e=this;o.Common.log("sendChannel open"),e.netip=new r.netIP,e.netip.setDataChannel(e.sendChannel);var t={EncryptType:"NONE",LoginType:"DVRIP-Web",PassWord:"1",UserName:"admin"};e.netip.sendOverNetIP(t,1e3)},e.prototype.onSendChannelClose=function(){o.Common.log("sendChannel close")},e.prototype.onReceiveMessageCallback=function(e){var t=this;o.Common.log("Received Message",e);var n=new Uint8Array(e.data,0,20),r=n[14]+256*n[15];if(1001==r){var a=n[4]+256*n[5]+65536*n[6]+16777216*n[7];t.netip.setSID(a),t.netip.heartBeat(),t.startOrStopMonitorOverNetIP(!0,10,0)}else if(1504==r){for(var i=new Uint8Array(e.data,20,e.data.byteLength-22),s="",c=0;c<i.length;c++)s+=String.fromCharCode(i[c]);JSON.parse(s)}else 1007==r&&(t.netip.heartbeatfailnum=0)},e.prototype.onReceiveChannelStateChange=function(){"open"==this.receiveChannel.readyState?o.Common.log("receiveChannel open"):o.Common.log("receiveChannel close")},e.prototype.startOrStopMonitorOverNetIP=function(e,t,n){var o=this,r={Name:"OPMonitor",OPMonitor:{Action:e?"Start":"Stop",Parameter:{Channel:t,CombinMode:"NONE",StreamType:0==n?"Main":"Extra",TransMode:"TCP"}},SessionID:"0x"+o.netip.getSID().toString(16)};o.netip.sendOverNetIP(r,1410)},e}();t.Signalling=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(4),r=n(6),a=n(9),i=n(0);window.XmWebRtc=function(){function e(){this.statusObj=new o.QueryStatus}return e.log=function(e){i.Common.logstatus=e},e.prototype.queryStatus=function(e,t,n){this.statusObj.status(e,t,n)},e.prototype.initLocalHostWebRtc=function(){},e.prototype.initAjaxWebRtc=function(e,t,n){var o=new r.AjaxWebRtc(e,t,n);return o.init(),o},e.prototype.initWebSocketWebRtc=function(e,t,n){return new a.WebSocketWebRtc(e,t,n)},e}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(0),r=n(5),a=function(){function e(){this.username="caiqianmeng",this.password="xmcloudsuperuser",this.token="",this.token_expire=0,this.token_expire_time=25e3,this.clientID=o.Common.clientID()}return e.prototype.status=function(e,t,n){var r=this;o.Common.log("token--\x3e",r.token),o.Common.log("token_expire--\x3e",r.token_expire),null==r.token||""==r.token||(new Date).getTime()-r.token_expire>r.token_expire_time?r.getToken(function(o){r.statusExecute(e,t,n)}):r.statusExecute(e,t,n)},e.prototype.statusExecute=function(e,t,n){var o=r.ParamConfig.queryStatus(this.clientID,this.token,e);this.ajax(o,t,n)},e.prototype.getToken=function(e){var t=this;t.login(function(n){var o=n.result.nonce,r=md5.base64(o+t.password);t.auth(t.username,r,function(n){t.token=n.result.token,t.token_expire=(new Date).getTime(),e(n)})})},e.prototype.login=function(e){var t=r.ParamConfig.login(this.clientID,this.username);this.ajax(t,e)},e.prototype.auth=function(e,t,n){var o=r.ParamConfig.auth(this.clientID,e,t);this.ajax(o,n)},e.prototype.ajax=function(e,t,n){void 0===n&&(n=null);o.Common.ajax(e,"http://xmcloud.xmsecu.com:9355/xmcloud/service",t,n)},e}();t.QueryStatus=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(){}return e.login=function(e,t){return{id:e,jsonrpc:"2.0",method:"xmcloud/service/login",params:{username:t}}},e.auth=function(e,t,n){return{id:e,jsonrpc:"2.0",method:"xmcloud/service/login",params:{username:t,password:n}}},e.queryStatus=function(e,t,n){return{id:e,jsonrpc:"2.0",token:t,method:"xmcloud/service/status/query",params:n}},e}();t.ParamConfig=o},function(e,t,n){"use strict";var o=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(7),a=n(0),i=n(1),s=n(2),c=function(e){function t(t,n,o){var a=e.call(this,t,n,o)||this;return a.url="http://"+a.serverIp+":"+a.serverPort,a.heartbeat=new r.Heartbeat(a.url),a}return o(t,e),t.prototype.init=function(){a.Common.log("AjaxWebRtc init");var e=this;e.coturn(function(t){"200"==t.RTCAccessProtocol.Header.ErrorNum&&(e.peerConnection=e.createRTCPeerConnection(),e.createDataChannel(e.peerConnection),e.sendOffer(e.peerConnection),e.iceCandidate(e.peerConnection),e.addStream(e.peerConnection))})},t.prototype.coturn=function(e){var t=i.ParamConfig.coturn(this.clientID,this.sn);this.ajax(t,e)},t.prototype.createOfferSuccessCallback=function(e){var t=this,n=e.localDescription.sdp;a.Common.log("sendOfferSuccessCallback",n);var o=i.ParamConfig.sdpOffer(t.clientID,t.sn,n);t.ajax(o,function(n){a.Common.log("heartbeat startAnswer");var o=n.RTCAccessProtocol,r=o.Body.errno;null==r?(t.heartbeat.startAnswer(t.sn,t.clientID,e),t.heartbeat.startIceCandidate(t.sn,t.clientID,e)):a.Common.log("device: ",t.sn," offline"," errno:",r)})},t.prototype.sendOfferFailureCallback=function(e,t){a.Common.log("sendOfferFailureCallback",t)},t.prototype.iceCandidateSuccessCallback=function(e,t){var n=this;a.Common.log("iceCandidateSuccessCallback",t);var o=i.ParamConfig.iceCandidate(n.clientID,n.sn,t);n.ajax(o,function(e){a.Common.log("heartbeat startIceCandidate")})},t.prototype.ajax=function(e,t){a.Common.ajax(e,this.url,t)},t}(s.Signalling);t.AjaxWebRtc=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(0),r=n(1),a=function(){function e(e){this.heartbeatAnswerCount=0,this.heartbeatIceCandidateCount=0,this.url=e}return e.prototype.startAnswer=function(e,t,n){var a=this,i=r.ParamConfig.sdpAnswer(t,e);a.heartbeatAnswer=setInterval(function(){o.Common.log("heartbeatAnswer",++a.heartbeatAnswerCount>1e4?a.heartbeatAnswerCount=1:a.heartbeatAnswerCount),a.ajax(i,function(e){var t=e.RTCAccessProtocol;if("200"==t.Header.ErrorNum){a.closeAnswer();var r=new RTCSessionDescription;r.sdp=t.Body.sdp,r.type="answer",o.Common.log(r),n.setRemoteDescription(r)}})},1e3)},e.prototype.closeAnswer=function(){null!=this.heartbeatAnswer&&clearInterval(this.heartbeatAnswer)},e.prototype.startIceCandidate=function(e,t,n){var a=this,i=r.ParamConfig.iceCandidateAnswer(t,e);null==a.heartbeatIceCandidate&&(a.heartbeatIceCandidate=setInterval(function(){o.Common.log("heartbeatIceCandidate",++a.heartbeatIceCandidateCount>1e4?a.heartbeatIceCandidateCount=1:a.heartbeatIceCandidateCount),a.ajax(i,function(e){var t=e.RTCAccessProtocol;"200"==t.Header.ErrorNum&&n.addIceCandidate(new RTCIceCandidate(t.Body.candidate))})},1e3))},e.prototype.closeIceCandidate=function(){null!=this.heartbeatIceCandidate&&clearInterval(this.heartbeatIceCandidate)},e.prototype.ajax=function(e,t){o.Common.ajax(e,this.url,t)},e}();t.Heartbeat=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(){this.HeadFlag=255,this.Version=0,this.Reserved1=0,this.Reserved2=0,this.SID=0,this.Seq=0,this.TotalPacket=0,this.CurPacket=0,this.MsgId=1e3,this.heartbeatinterval=null,this.heartbeatfailnum=0}return e.prototype.setDataChannel=function(e){this.DC=e},e.prototype.setSID=function(e){this.SID=e},e.prototype.getSID=function(){return this.SID},e.prototype.sendOverNetIP=function(e,t,n){n||(n=this),console.log("MsgId = ",t);var o=JSON.stringify(e);n.DataLen=o.length,n.MsgId=t;for(var r=new Uint8Array(20+o.length),a=n.GetHead(),i=0;i<20;i++)r[i]=a[i];for(var i=0;i<o.length;i++)r[20+i]=o.charCodeAt(i);n.DC.send(r.buffer),n.Seq++,1006==t&&++n.heartbeatfailnum>3&&console.log("detected disconnect!!!!!!!!")},e.prototype.heartBeat=function(){var e={Name:"KeepAlive",SessionID:"0x"+this.SID.toString(16)},t=this;this.heartbeatinterval=setInterval(t.sendOverNetIP,1e4,e,1006,t)},e.prototype.Get8=function(e,t){return(e&4278190080>>8*(t-1))>>8*(4-t)},e.prototype.GetHead=function(){return new Uint8Array([this.HeadFlag,this.Version,this.Reserved1,this.Reserved2,this.Get8(this.SID,4),this.Get8(this.SID,3),this.Get8(this.SID,2),this.Get8(this.SID,2),this.Get8(this.Seq,4),this.Get8(this.Seq,3),this.Get8(this.Seq,2),this.Get8(this.Seq,1),this.TotalPacket,this.CurPacket,this.Get8(this.MsgId,4),this.Get8(this.MsgId,3),this.Get8(this.DataLen,4),this.Get8(this.DataLen,3),this.Get8(this.DataLen,2),this.Get8(this.DataLen,1)])},e}();t.netIP=o},function(e,t,n){"use strict";var o=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),a=n(2),i=n(1),s=function(e){function t(t,n,o){var r=e.call(this,t,n,o)||this;return r.webSocket=null,r.url="ws://"+r.serverIp+":"+r.serverPort,r.initWebSocket(r.url),r}return o(t,e),t.prototype.initWebSocket=function(e){var t=this;r.Common.log("WebSocketWebRtc init"),"WebSocket"in window?(this.webSocket=new WebSocket(e),this.webSocket.onopen=function(e){r.Common.log("webSocket onopen",e);var n=i.ParamConfig.coturn(t.clientID,t.sn);r.Common.log("send coturn",n),t.sendMsg(n)},this.webSocket.onerror=function(e){r.Common.log("webSocket onerror",e)},this.webSocket.onmessage=function(e){r.Common.log("--------webSocket onmessage",e.data);try{var n=JSON.parse(e.data),o=n.RTCAccessProtocol,a=o.Header;if(null!=a){var i=o.Body,s=a.MessageType;"MSG_COTURN_RSP"==s?t.setOnCoturn(i):(s="MSG_CONNECT_REQ")?t.setOnSdpOrIceCandidate(i):r.Common.log("not found messageType",s)}}catch(e){r.Common.log("exception",e)}},this.webSocket.onclose=function(e){r.Common.log("webSocket onclose",e)},window.onbeforeunload=function(){t.close()}):alert("Not support websocket")},t.prototype.setOnCoturn=function(e){var t=this;t.peerConnection=t.createRTCPeerConnection(),t.createDataChannel(t.peerConnection),t.sendOffer(t.peerConnection),t.iceCandidate(t.peerConnection),t.addStream(t.peerConnection)},t.prototype.setOnSdpOrIceCandidate=function(e){var t=this;if(r.Common.log("------------------------",e),null!=e.sdp){var n=new RTCSessionDescription;n.sdp=e.sdp,n.type="answer",r.Common.log("setRemoteDescription",n),t.peerConnection.setRemoteDescription(n)}null!=e.candidate&&(r.Common.log("addIceCandidate",e.candidate),this.peerConnection.addIceCandidate(new RTCIceCandidate(e.candidate)))},t.prototype.createOfferSuccessCallback=function(e){var t=this,n=e.localDescription.sdp;r.Common.log("sendOfferSuccessCallback",n);var o=i.ParamConfig.sdpOffer(t.clientID,t.sn,n);this.sendMsg(o)},t.prototype.sendOfferFailureCallback=function(e,t){},t.prototype.iceCandidateSuccessCallback=function(e,t){var n=this;r.Common.log("iceCandidateSuccessCallback",t);var o=i.ParamConfig.iceCandidate(n.clientID,n.sn,t);this.sendMsg(o)},t.prototype.sendMsg=function(e){null!=this.webSocket?(e instanceof Object&&(e=JSON.stringify(e)),this.webSocket.send(e)):alert("webSocket not init.")},t.prototype.close=function(){null!=this.webSocket&&this.webSocket.close()},t}(a.Signalling);t.WebSocketWebRtc=s}]);